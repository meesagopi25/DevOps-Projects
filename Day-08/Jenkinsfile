pipeline {
    agent any

    environment {
        // Ensure these Credentials IDs match exactly what you created in Jenkins
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        // This must match the 'Name' given in Global Tool Configuration
        TF_HOME               = tool 'Terraform'
    }

    stages {
        stage('Checkout') {
            steps {
                // Checkout the code from your repository
                checkout scm
            }
        }

        stage('Terraform Plan') {
            steps {
                dir('Day-08') {
                    sh "${TF_HOME}/terraform init"
                    sh "${TF_HOME}/terraform plan -out=tfplan"
                }
            }
        }

        stage('Terraform Apply') {
            steps {
                dir('Day-08') {
                    sh "${TF_HOME}/terraform apply -auto-approve tfplan"
                    
                    // Extract the Public IP from Terraform output to use in Ansible
                    script {
                        def publicIp = sh(script: "${TF_HOME}/terraform output -raw public_ip", returnStdout: true).trim()
                        env.INSTANCE_IP = publicIp
                    }
                }
            }
        }

        stage('Configure with Ansible') {
            steps {
                dir('Day-08') {
                    // Use the SSH private key stored in Jenkins credentials
                    // Ensure you have an SSH Secret Key credential with ID 'ec2-ssh-key'
                    withCredentials([sshUserPrivateKey(credentialsId: 'ec2-ssh-key', keyFileVariable: 'SSH_KEY')]) {
                        sh """
                        echo "[web_servers]\n${env.INSTANCE_IP} ansible_user=ubuntu" > inventory.ini
                        
                        ansible-playbook -i inventory.ini nginx_playbook.yml \
                            --private-key ${SSH_KEY} \
                            --ssh-common-args='-o StrictHostKeyChecking=no'
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            // Cleans the workspace after the run to keep the Jenkins server tidy
            cleanWs()
        }
    }
}
